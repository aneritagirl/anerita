<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MYQER — MVP Offline/Online Hybrid QR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;text-align:center;padding:2rem}
    h1{margin:0 0 16px}
    #qr{image-rendering:pixelated;border:1px solid #ddd}
    #payload{width: min(720px, 92vw); margin: 12px auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    #debug{color:#b00; font-family: ui-monospace, Menlo, Consolas, monospace; white-space: pre-wrap;}
  </style>
</head>
<body>
  <h1>MYQER — Hybrid QR Demo</h1>
  <canvas id="qr" width="300" height="300" aria-label="QR"></canvas>
  <input id="payload" readonly />

  <pre id="debug"></pre>

  <script>
  // -------- tiny QR (no CDN) ----------
  const simpleQR = (function(){
    function QR8(d){this.d=d}
    QR8.prototype={L(){return new TextEncoder().encode(this.d).length},W(b){for(const x of new TextEncoder().encode(this.d))b.put(x,8)}};
    function Buf(){this.b=[];this.len=0} Buf.prototype.put=function(n,l){for(let i=0;i<l;i++)this.b.push(((n>>>(l-i-1))&1)?1:0),this.len++};
    function RS(t,d){this.t=t;this.d=d}
    const PAD0=0xEC, PAD1=0x11;
    const RS_TAB={1:[1,9,7],2:[1,16,10],3:[1,26,15],4:[1,36,20],5:[1,44,26],6:[2,60,36],7:[2,66,43],8:[2,86,54],9:[2,100,69],10:[4,122,84],11:[4,140,93],12:[4,158,107],13:[4,180,115],14:[4,197,131]};
    const blocks=(t)=>{const a=RS_TAB[t],o=[];for(let i=0;i<a[0];i++)o.push(new RS(a[1],a[2]));return o};
    function QR(n){this.n=n||0;this.m=null;this.N=0;this.list=[]}
    QR.prototype={add(d){this.list.push(new QR8(d))},
      make(){if(this.n<1){for(let t=1;t<=14;t++){this.n=t;if(this.maxBits()>=this.len())break}}
        this.N=this.n*4+17;this.m=Array.from({length:this.N},()=>Array(this.N).fill(null));
        this.pp(0,0);this.pp(this.N-7,0);this.pp(0,this.N-7);this.tp();this.map(this.data());this.mask()},
      dark(r,c){return this.m[r][c]}, len(){return this.list.reduce((n,d)=>n+d.L(),0)},
      maxBits(){return blocks(this.n).reduce((n,b)=>n+b.d,0)*8-4},
      pp(R,C){for(let r=-1;r<=7;r++)for(let c=-1;c<=7;c++){const rr=R+r,cc=C+c;if(rr<0||rr>=this.N||cc<0||cc>=this.N)continue;this.m[rr][cc]=(r>=0&&r<=6&&(c===0||c===6))||(c>=0&&c<=6&&(r===0||r===6))||(r>=2&&r<=4&&c>=2&&c<=4)}},
      tp(){for(let i=8;i<this.N-8;i++){const v=i%2===0;if(this.m[i][6]==null)this.m[i][6]=v;if(this.m[6][i]==null)this.m[6][i]=v}},
      data(){const rs=blocks(this.n),buf=new Buf();for(const d of this.list){buf.put(4,4);buf.put(d.L(),8);d.W(buf)}const total=rs.reduce((n,b)=>n+b.d,0),max=total*8;if(buf.len+4<=max)buf.put(0,4);while(buf.len%8)buf.put(0,1);let pad=true;while(buf.len<max){buf.put(pad?PAD0:PAD1,8);pad=!pad}const out=[];for(let i=0;i<buf.len;i+=8){let v=0;for(let j=0;j<8;j++)v=(v<<1)|buf.b[i+j];out.push(v)}return out},
      map(D){let r=this.N-1,c=this.N-1,dir=-1,bi=0,bb=7;const nb=()=>{const v=(D[bi]>>>bb)&1;if(--bb<0){bi++;bb=7}return v};while(c>0){if(c===6)c--;for(let i=0;i<this.N;i++){const rr=r+dir*i,cs=[c,c-1];for(const cc of cs)if(this.m[rr]&&this.m[rr][cc]==null)this.m[rr][cc]=nb()===1}r+=dir*this.N;dir=-dir;c-=2}},
      mask(){const S=[];for(let m=0;m<4;m++){const cp=this.m.map(r=>r.slice());for(let r=0;r<this.N;r++)for(let c=0;c<this.N;c++){if(cp[r][c]==null)continue;
            if(m===0)cp[r][c]=((r+c)%2===0)?!cp[r][c]:cp[r][c];
            if(m===1)cp[r][c]=(r%2===0)?!cp[r][c]:cp[r][c];
            if(m===2)cp[r][c]=(c%3===0)?!cp[r][c]:cp[r][c];
            if(m===3)cp[r][c]=((r+c)%3===0)?!cp[r][c]:cp[r][c]}
          S.push({m,cp,score:this.sc(cp)})}S.sort((a,b)=>a.score-b.score);this.m=S[0].cp},
      sc(M){const n=M.length;let dark=0,runs=0;for(let r=0;r<n;r++)for(let c=0;c<n;c++){if(M[r][c])dark++;if(c&&M[r][c]===M[r][c-1])runs++}for(let c=0;c<n;c++)for(let r=0;r<n;r++)if(r&&M[r][c]===M[r-1][c])runs++;const ratio=Math.abs(dark/(n*n)-0.5)*100;return runs+ratio}
    };
    function svg(text,size=300,margin=4){
      const q=new QR(0); q.add(text||''); q.make(); const m=q.m, n=m.length;
      const scale=Math.max(1,Math.floor(size/(n+2*margin))), dim=scale*(n+2*margin);
      let d=''; for(let r=0;r<n;r++)for(let c=0;c<n;c++) if(m[r][c]) d+=`M${(c+margin)*scale} ${(r+margin)*scale}h${scale}v${scale}h-${scale}z`;
      return {w:dim,h:dim,svg:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${dim} ${dim}" shape-rendering="crispEdges"><rect width="100%" height="100%" fill="#fff"/><path d="${d}" fill="#000"/></svg>`};
    }
    function toCanvas(canvas, text, size=300, margin=4){
      const out=svg(text,size,margin); const img=new Image();
      const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(out.svg);
      return new Promise((res,rej)=>{ img.onload=()=>{canvas.width=out.w;canvas.height=out.h;const ctx=canvas.getContext('2d');ctx.imageSmoothingEnabled=false;ctx.clearRect(0,0,out.w,out.h);ctx.drawImage(img,0,0,out.w,out.h);res();}; img.onerror=rej; img.src=url;});
    }
    return { toCanvas };
  })();
  // -------- end tiny QR ----------

  function showError(msg){
    document.getElementById('debug').textContent = String(msg);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try{
      const profile = {
        name:"Anita Boros",
        dob:"1988-10-13",
        country:"GB",
        blood:"O+",
        allergies:"Penicillin, Codeine, Midazolam",
        conditions:"Alport Syndrome",
        donor:"Y",
        url:"https://myqer.com/c/6P6NH6"
      };

      // URL first (ensures iOS/Android camera shows the open-link banner)
      const payload =
`${profile.url}

Name: ${profile.name}
DOB: ${profile.dob}
Country: ${profile.country}
BT: ${profile.blood}
ALG: ${profile.allergies}
COND: ${profile.conditions}
DONOR: ${profile.donor}`;

      document.getElementById('payload').value = payload.split('\n')[0]; // show the URL
      await simpleQR.toCanvas(document.getElementById('qr'), payload, 300, 4);
    }catch(e){ showError(e && e.message ? e.message : e); }
  });
  </script>
</body>
</html>
